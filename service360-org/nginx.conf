worker_processes auto;
error_log logs/error.log;
pid logs/nginx.pid;

events {
    worker_connections 1024;
}

http {
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log logs/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    include mime.types;
    default_type application/octet-stream;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=login:10m rate=5r/s;

    # Upstream servers
    upstream adm_backend {
        server 192.168.1.215:9172;
    }

    upstream meta_backend {
        server 192.168.1.215:9173;
    }

    upstream account_backend {
        server 192.168.1.215:9174;
    }

    upstream tofidata_backend {
        server 192.168.1.215:9175;
    }

    upstream cube_backend {
        server 192.168.1.215:9176;
    }

    upstream nsi_backend {
        server 192.168.1.215:9177;
    }

    upstream objects_backend {
        server 192.168.1.215:9178;
    }

    upstream plan_backend {
        server 192.168.1.215:9179;
    }

    upstream personnal_backend {
        server 192.168.1.215:9180;
    }

    upstream orgstructure_backend {
        server 192.168.1.215:9181;
    }

    upstream inspections_backend {
        server 192.168.1.215:9182;
    }

    upstream client_backend {
        server 192.168.1.215:9183;
    }

    upstream incident_backend {
        server 192.168.1.215:9184;
    }

    upstream resource_backend {
        server 192.168.1.215:9185;
    }

    upstream repair_backend {
        server 192.168.1.215:9186;
    }

    upstream report_backend {
        server 192.168.1.215:9187;
    }

    server {
        listen 0.0.0.0:80;
        server_name 192.168.1.215 127.0.0.1;

        # App frontend
        location /dtj {
            alias C:/dtj/web/dtj;
            try_files $uri $uri/ /dtj/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # DTJ Admin API - префиксный путь
        location ~ ^/dtj/admin/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_admin_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/admin prefix
            rewrite ^/dtj/admin/(.*)$ /$1 break;
            
            proxy_pass http://adm_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Admin frontend - префиксный путь
        location /dtj/admin {
            alias C:/dtj/web/admin;

            try_files $uri $uri/ /dtj/admin/index.html;
            
            # Debug headers
            add_header X-Debug-Location "dtj_admin_frontend" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # DTJ Meta API - префиксный путь
        location ~ ^/dtj/meta/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_meta_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/meta prefix
            rewrite ^/dtj/meta/(.*)$ /$1 break;
            
            proxy_pass http://meta_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Meta frontend - префиксный путь
        location /dtj/meta {
            alias C:/dtj/web/meta;
            try_files $uri $uri/ /dtj/meta/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # DTJ NSI API - префиксный путь
        location ~ ^/dtj/nsi/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_nsi_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/nsi prefix
            rewrite ^/dtj/nsi/(.*)$ /$1 break;
            
            proxy_pass http://nsi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ NSI frontend - префиксный путь
        location /dtj/nsi {
            alias C:/dtj/web/nsi;
            try_files $uri $uri/ /dtj/nsi/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # DTJ Account API - префиксный путь
        location ~ ^/dtj/account/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_account_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/account prefix
            rewrite ^/dtj/account/(.*)$ /$1 break;
            
            proxy_pass http://account_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Account frontend - префиксный путь
        location /dtj/account {
            alias C:/dtj/web/account;
            try_files $uri $uri/ /dtj/account/index.html;
            
            # Debug headers
            add_header X-Debug-Location "dtj_account_frontend" always;
            add_header X-Debug-Request-URI $request_uri always;
           
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # DTJ TofiData API - префиксный путь
        location ~ ^/dtj/tofidata/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_tofidata_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/tofidata prefix
            rewrite ^/dtj/tofidata/(.*)$ /$1 break;
            
            proxy_pass http://tofidata_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ TofiData frontend - префиксный путь
        location /dtj/tofidata {
            alias C:/dtj/web/tofidata;
            try_files $uri $uri/ /dtj/tofidata/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # DTJ Cube API - префиксный путь
        location ~ ^/dtj/cube/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_cube_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/cube prefix
            rewrite ^/dtj/cube/(.*)$ /$1 break;
            
            proxy_pass http://cube_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Cube frontend - префиксный путь
        location /dtj/cube {
            alias C:/dtj/web/cube;
            try_files $uri $uri/ /dtj/cube/index.html;

            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }

        }


        location /dtj/service {
            alias C:/dtj/web/service;
            try_files $uri $uri/ /dtj/service/index.html;
            
            # Debug headers
            add_header X-Debug-Location "dtj_service_frontend" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }



        # DTJ Service frontend - префиксный путь
        location /dtj/ops {
            alias C:/dtj/web/ops;
            try_files $uri $uri/ /dtj/ops/index.html;
            
            # Debug headers
            add_header X-Debug-Location "dtj_ops_frontend" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # DTJ Service frontend - префиксный путь
        location /dtj/org {
            alias C:/dtj/web/org;
            try_files $uri $uri/ /dtj/org/index.html;
            
            # Debug headers
            add_header X-Debug-Location "dtj_org_frontend" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }


        # Admin API - только для API запросов
        location ~ ^/admin/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "admin_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /admin prefix
            rewrite ^/admin/(.*)$ /$1 break;
            
            proxy_pass http://adm_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }
        
        # Admin frontend
        location /admin {
            alias C:/dtj/web/admin;
            try_files $uri $uri/ /admin/index.html;
            
            # Debug headers
            add_header X-Debug-Location "admin_frontend" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }



        # Meta API - должен быть перед /meta frontend
        location ~ ^/meta/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "meta_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /meta prefix
            rewrite ^/meta/(.*)$ /$1 break;
            
            proxy_pass http://meta_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # Meta frontend
        location /meta {
            alias C:/dtj/web/meta;
            try_files $uri $uri/ /meta/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # NSI API - только для API запросов
        location ~ ^/nsi/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "nsi_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /nsi prefix
            rewrite ^/nsi/(.*)$ /$1 break;
            
            proxy_pass http://nsi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # NSI frontend
        location /nsi {
            alias C:/dtj/web/nsi;
            try_files $uri $uri/ /nsi/index.html;
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # User Data API - только для API запросов
        location ~ ^/account/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "account_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /account prefix
            rewrite ^/account/(.*)$ /$1 break;
            
            proxy_pass http://account_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # User Data frontend
        location /account {
            alias C:/dtj/web/account;
            try_files $uri $uri/ /account/index.html;

            # Debug headers
            add_header X-Debug-Location "account_frontend" always;
            add_header X-Debug-Request-URI $request_uri always;
           
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }


        # Data API - только для API запросов
        location ~ ^/tofidata/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "tofidata_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /tofidata prefix
            rewrite ^/tofidata/(.*)$ /$1 break;
            
            proxy_pass http://tofidata_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }


        # Data frontend
        location /tofidata {
            alias C:/dtj/web/tofidata;
            try_files $uri $uri/ /tofidata/index.html;
            
            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }


        # Cube API - только для API запросов
        location ~ ^/cube/(auth|api) {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "cube_api" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /cube prefix
            rewrite ^/cube/(.*)$ /$1 break;
            
            proxy_pass http://cube_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }


        # Cube frontend
        location /cube {
            alias C:/dtj/web/cube;
            try_files $uri $uri/ /cube/index.html;

            # Cache static assets
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }


        # DTJ Admin API - префиксный путь
        location /dtj/api/admin/ {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_admin" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/admin prefix
            rewrite ^/dtj/api/admin/(.*)$ /$1 break;
            
            proxy_pass http://adm_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # Admin API
        location /api/admin/ {
            limit_req zone=api burst=20 nodelay;
            
            # Rewrite: remove /api/admin prefix
            rewrite ^/api/admin/(.*)$ /$1 break;
            
            proxy_pass http://adm_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Meta API - префиксный путь
        location /dtj/api/meta/ {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_meta" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/meta prefix
            rewrite ^/dtj/api/meta/(.*)$ /$1 break;
            
            proxy_pass http://meta_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # Meta API
        location /api/meta/ {
            limit_req zone=api burst=20 nodelay;
            
            # Rewrite: remove /api/meta prefix
            rewrite ^/api/meta/(.*)$ /$1 break;
            
            proxy_pass http://meta_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Account API - префиксный путь
        location /dtj/api/account/ {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_account" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/account prefix
            rewrite ^/dtj/api/account/(.*)$ /$1 break;
            
            proxy_pass http://account_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # UserData API
        location /api/account/ {
            limit_req zone=api burst=20 nodelay;
            
            # Rewrite: remove /api/account prefix
            rewrite ^/api/account/(.*)$ /$1 break;
            
            proxy_pass http://account_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ TofiData API - префиксный путь
        location /dtj/api/tofidata/ {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_tofidata" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/tofidata prefix
            rewrite ^/dtj/api/tofidata/(.*)$ /$1 break;
            
            proxy_pass http://tofidata_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # TofiData API
        location /api/tofidata/ {
            limit_req zone=api burst=20 nodelay;
            
            # Rewrite: remove /api/tofidata prefix
            rewrite ^/api/tofidata/(.*)$ /$1 break;
            
            proxy_pass http://tofidata_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Cube API - префиксный путь
        location /dtj/api/cube/ {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_cube" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/cube prefix
            rewrite ^/dtj/api/cube/(.*)$ /$1 break;
            
            proxy_pass http://cube_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # Cube API
        location /api/cube/ {
            limit_req zone=api burst=20 nodelay;
            
            # Rewrite: remove /api/cube prefix
            rewrite ^/api/cube/(.*)$ /$1 break;
            
            proxy_pass http://cube_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ NSI API - префиксный путь
        location /dtj/api/nsi/ {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_nsi" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/nsi prefix
            rewrite ^/dtj/api/nsi/(.*)$ /$1 break;
            
            proxy_pass http://nsi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Plan API - префиксный путь
        location /dtj/api/plan {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_plan" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/plan prefix
            rewrite ^/dtj/api/plan(.*)$ /api$1 break;
            
            proxy_pass http://plan_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Inspections API - префиксный путь
        location /dtj/api/inspections {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_inspections" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/inspections prefix
            rewrite ^/dtj/api/inspections(.*)$ /api$1 break;
            
            proxy_pass http://inspections_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Objects API - префиксный путь
        location /dtj/api/objects {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_objects" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/objects prefix
            rewrite ^/dtj/api/objects(.*)$ /api$1 break;
            
            proxy_pass http://objects_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ OrgStructure API - префиксный путь
        location /dtj/api/orgstructure {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_orgstructure" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/orgstructure prefix
            rewrite ^/dtj/api/orgstructure(.*)$ /api$1 break;
            
            proxy_pass http://orgstructure_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Client API - префиксный путь
        location /dtj/api/client {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_client" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/client prefix
            rewrite ^/dtj/api/client(.*)$ /api$1 break;
            
            proxy_pass http://client_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Incident API - префиксный путь
        location /dtj/api/incident {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_incident" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/incident prefix
            rewrite ^/dtj/api/incident(.*)$ /api$1 break;
            
            proxy_pass http://incident_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Resource API - префиксный путь
        location /dtj/api/resource {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_resource" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/resource prefix
            rewrite ^/dtj/api/resource(.*)$ /api$1 break;
            
            proxy_pass http://resource_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Personnal API - префиксный путь
        location /dtj/api/personnal {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_personnal" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/personnal prefix
            rewrite ^/dtj/api/personnal(.*)$ /api$1 break;
            
            proxy_pass http://personnal_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Repair API - префиксный путь
        location /dtj/api/repair {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_repair" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/repair prefix
            rewrite ^/dtj/api/repair(.*)$ /api$1 break;
            
            proxy_pass http://repair_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # DTJ Report API - префиксный путь
        location /dtj/api/report {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "dtj_api_report" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            # Rewrite: remove /dtj/api/report prefix
            rewrite ^/dtj/api/report(.*)$ /api$1 break;
            
            proxy_pass http://report_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }



        # Service Auth endpoints - для авторизации через NSI
        location /auth {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "service_auth" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            proxy_pass http://personnal_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }


        location /upload {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "service_upload" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            proxy_pass http://nsi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        location /download {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "service_download" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            proxy_pass http://nsi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        location /loadReport {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "service_loadreport" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            proxy_pass http://report_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        location /filldata {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "service_filldata" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            proxy_pass http://nsi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # Service UserAPI endpoints - для получения информации о пользователе
        location /userapi {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "service_userapi" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            proxy_pass http://personnal_backend/api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # Service UserInfo endpoints - для получения персональной информации
        location /userinfo {
            limit_req zone=api burst=20 nodelay;
            
            # Debug headers
            add_header X-Debug-Location "service_userinfo" always;
            add_header X-Debug-Request-URI $request_uri always;
            
            proxy_pass http://plan_backend/api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }

        # NSI API
        location /api/nsi/ {
            limit_req zone=api burst=20 nodelay;
            
            # Rewrite: remove /api/nsi prefix
            rewrite ^/api/nsi/(.*)$ /$1 break;
            
            proxy_pass http://nsi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle multipart/form-data
            client_max_body_size 10M;
            proxy_request_buffering off;
            proxy_method $request_method;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            
            # Timeouts
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }


        # Health check endpoints
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Default redirect to admin
        location = / {
            return 301 /admin;
        }

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }
} 